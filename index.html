<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Journey to Health — Search for Clinical Trials</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#f5f8fb }
  header { background:#0b6ea9; color:#fff; padding:16px; text-align:center; font-weight:600 }
  .wrap { max-width:1000px; margin:0 auto; padding:20px }
  .card { background:#fff; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.06); padding:16px; margin:16px 0 }
  h2 { margin:0 0 10px; color:#0b6ea9; font-size:1.2rem }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center }
  input, textarea { padding:10px; border:1px solid #d8e2ea; border-radius:8px; font:inherit }
  .btn { background:#0b6ea9; color:#fff; border:none; border-radius:8px; padding:10px 14px; cursor:pointer }
  .btn.secondary { background:#e8f1f9; color:#0b3a55 }
  .muted { color:#5a6b78; font-size:13px }
  .trial { padding:10px 0; border-bottom:1px solid #eef3f7 }
  .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef6fb; color:#0a4561; font-size:12px; margin-left:6px }
  /* Modal */
  .modal { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:16px; z-index:1000 }
  .modal[aria-hidden="false"]{ display:flex }
  .modal-card { background:#fff; max-width:800px; width:100%; border-radius:12px; padding:16px; box-shadow:0 12px 32px rgba(0,0,0,.25) }
  .modal-head, .modal-foot { display:flex; align-items:center; justify-content:space-between; gap:8px }
  .disclaimer { font-size:12px; color:#6b7280 }
</style>
</head>
<body>
<header>Search for Clinical Trials</header>
<div class="wrap">

  <!-- Clinical Trials Search (uses StudyFields endpoint: CORS-friendly) -->
  <div class="card">
    <h2>Search for Clinical Trials</h2>
    <div class="row">
      <input id="q" placeholder="Enter condition, gene, or keyword (e.g., CCUS, U2AF1)" style="flex:1; min-width:260px" />
      <button class="btn" onclick="runSearch()">Search</button>
      <button class="btn secondary" onclick="clearSearch()">Reset</button>
    </div>
    <div id="status" class="muted" style="margin-top:8px"></div>
    <div id="results" style="margin-top:12px"></div>
  </div>

  <!-- Connectivity Check (helps diagnose blockers) -->
  <div class="card">
    <h2>Connectivity Check</h2>
    <p class="muted">If Live search fails, run this quick test to see if your browser/network is blocking the API.</p>
    <div class="row">
      <button class="btn secondary" onclick="selfTest()">Run self‑test</button>
      <span id="selfHint" class="muted"></span>
    </div>
    <div id="selfOut" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- Pre‑Clinical Trial Research -->
  <div class="card">
    <h2>Search Here for Pre‑Clinical Trial Research</h2>
    <p class="muted">Open official resources in new tabs.</p>
    <div class="row">
      <input id="nihq" placeholder="Enter topic, gene, or condition" style="flex:1; min-width:260px" />
      <button class="btn" onclick="openRePORTER()">NIH RePORTER</button>
      <button class="btn secondary" onclick="openPubMed()">PubMed</button>
    </div>
  </div>

  <!-- Email Trial Coordinator -->
  <div class="card">
    <h2>Contact Trial Coordinator</h2>
    <p class="muted">Send an inquiry to the trial coordinator for more information.</p>
    <div class="row">
      <input id="trialId" placeholder="Enter NCT Number" />
      <input id="yourName" placeholder="Your Name" />
      <input id="yourEmail" type="email" placeholder="Your Email" />
    </div>
    <textarea id="message" placeholder="Your message to the coordinator..." style="margin-top:8px; width:100%; min-height:90px"></textarea>
    <div class="row" style="margin-top:8px">
      <button class="btn" onclick="sendEmail()">Send Email</button>
      <span id="emailStatus" class="muted"></span>
    </div>
  </div>
</div>

<!-- Plain‑language Explanation Modal -->
<div id="explainModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="explainTitle">
  <div class="modal-card">
    <div class="modal-head">
      <h3 id="explainTitle" style="margin:0; color:#0b6ea9">Plain‑language summary</h3>
      <div>
        <button class="btn secondary" onclick="copyExplanation()">Copy</button>
        <button class="btn secondary" onclick="printExplanation()">Print</button>
        <button class="btn" onclick="closeExplain()">Close</button>
      </div>
    </div>
    <div id="explainBody" class="muted" style="margin-top:10px; white-space:pre-wrap"></div>
    <div class="modal-foot">
      <span class="disclaimer">This summary is for information only and is not medical advice. Always discuss options with your clinician.</span>
    </div>
  </div>
</div>

<script>
let lastRows = [];

function fields(){
  return [
    'NCTId','BriefTitle','OverallStatus','Phase','LeadSponsorName',
    'LocationCity','LocationState','LocationCountry',
    'CentralContactName','CentralContactEMail','CentralContactPhone'
  ].join(',');
}

function clearSearch(){
  document.getElementById('q').value = '';
  document.getElementById('results').innerHTML = '';
  document.getElementById('status').textContent = '';
}

async function runSearch(){
  const q = document.getElementById('q').value.trim();
  const status = document.getElementById('status');
  const out = document.getElementById('results');
  if(!q){ out.innerHTML = '<div class="muted">Enter a keyword to search ClinicalTrials.gov.</div>'; return; }
  out.innerHTML = '';
  status.textContent = 'Searching ClinicalTrials.gov…';
  const url = `https://clinicaltrials.gov/api/query/study_fields?expr=${encodeURIComponent(q)}&fields=${fields()}&min_rnk=1&max_rnk=40&fmt=json`;
  try{
    const res = await fetch(url); // StudyFields is CORS-enabled
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    lastRows = data?.StudyFieldsResponse?.StudyFields || [];
    if(!lastRows.length){ out.innerHTML = '<div class="muted">No trials found.</div>'; status.textContent = ''; return; }
    out.innerHTML = lastRows.map(renderRow).join('');
    status.textContent = `Showing ${lastRows.length} result(s).`;
  }catch(e){
    console.error(e);
    const testUrl = `https://clinicaltrials.gov/api/query/study_fields?expr=${encodeURIComponent(q)}&fields=NCTId&min_rnk=1&max_rnk=1&fmt=json`;
    status.innerHTML = `Could not fetch live results. This is often a browser extension or network policy issue. Try the API test: <a href="${testUrl}" target="_blank" rel="noopener">open</a> or run the Connectivity Check below.`;
    out.innerHTML = '';
  }
}

function renderRow(r){
  const id = (r.NCTId||[])[0]||'';
  const title = (r.BriefTitle||[])[0]||'Untitled study';
  const phase = (r.Phase||[])[0]||'';
  const status = (r.OverallStatus||[])[0]||'';
  const sponsor = (r.LeadSponsorName||[])[0]||'';
  const city = (r.LocationCity||[])[0]||'';
  const state = (r.LocationState||[])[0]||'';
  const country = (r.LocationCountry||[])[0]||'';
  const email = (r.CentralContactEMail||[])[0]||'';
  const phone = (r.CentralContactPhone||[])[0]||'';

  const loc = [city,state,country].filter(Boolean).join(', ') || 'Location not listed';
  const contact = [email, phone].filter(Boolean).join(' · ');

  const emailBtn = email ? `<a class="btn secondary" href="mailto:${email}?subject=${encodeURIComponent('Inquiry about '+id)}">Email Coordinator</a>` : '';
  const explainBtn = `<button class="btn secondary" onclick="openExplain('${id}')">Explain in plain language</button>`;

  return `<div class="trial">
    <div><strong>${escapeHtml(title)}</strong> (<a target="_blank" rel="noopener" href="https://clinicaltrials.gov/study/${id}">${id}</a>)
      ${phase?`<span class='pill'>${escapeHtml(phase)}</span>`:''}
      ${status?`<span class='pill'>${escapeHtml(status)}</span>`:''}
    </div>
    <div class="muted">${escapeHtml(loc)} ${sponsor?` · Sponsor: ${escapeHtml(sponsor)}`:''}</div>
    <div class="row" style="margin-top:6px">
      ${emailBtn}
      ${explainBtn}
      <a class="btn" target="_blank" rel="noopener" href="https://clinicaltrials.gov/study/${id}">Open on ClinicalTrials.gov</a>
    </div>
    ${contact?`<div class="muted" style="margin-top:6px">Contact: ${escapeHtml(contact)}</div>`:''}
  </div>`;
}

function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

// Plain-language modal (uses available fields; for deeper text we can add a backend later)
function openExplain(nct){
  const r = lastRows.find(x => (x.NCTId||[])[0] === nct);
  if(!r) return;
  const title = (r.BriefTitle||[])[0]||nct;
  const phase = (r.Phase||[])[0]||'';
  const status = (r.OverallStatus||[])[0]||'';
  const loc = [ (r.LocationCity||[])[0]||'', (r.LocationState||[])[0]||'', (r.LocationCountry||[])[0]||'' ].filter(Boolean).join(', ');
  const email = (r.CentralContactEMail||[])[0]||'';
  const phone = (r.CentralContactPhone||[])[0]||'';

  const lines = [];
  lines.push(`Study: ${title}`);
  lines.push(`NCT ID: ${nct}`);
  if(phase) lines.push(`Phase: ${phase}`);
  if(status) lines.push(`Status: ${status}`);
  if(loc) lines.push(`Where: ${loc}`);
  if(email||phone) lines.push(`Contact: ${[email,phone].filter(Boolean).join(' · ')}`);
  lines.push("\nWhat this means in plain terms:\nThis is a clinical research study. The phase tells you how early or advanced the testing is (Phase 1 = early safety, Phase 2 = effectiveness and dosing, Phase 3 = larger comparison). ‘Recruiting’ means the study is open to new participants. Always review the full details on ClinicalTrials.gov and talk with your clinician.");

  document.getElementById('explainTitle').textContent = `Plain‑language summary — ${nct}`;
  document.getElementById('explainBody').textContent = lines.join('\n');
  document.getElementById('explainModal').setAttribute('aria-hidden','false');
}
function closeExplain(){ document.getElementById('explainModal').setAttribute('aria-hidden','true'); }
function copyExplanation(){ const t=document.getElementById('explainBody').textContent; navigator.clipboard.writeText(t).then(()=>alert('Summary copied')); }
function printExplanation(){
  const title = document.getElementById('explainTitle').textContent;
  const body = document.getElementById('explainBody').textContent + "\n\nThis summary is for information only and is not medical advice.";
  const w = window.open('', '_blank');
  w.document.write('<pre style="font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; white-space: pre-wrap; line-height:1.3;">');
  w.document.write(title + "\n\n" + body.replace(/</g,'&lt;').replace(/>/g,'&gt;'));
  w.document.write('</pre>');
  w.document.close(); w.focus(); w.print();
}

// NIH helpers
function openRePORTER(){ const q=(document.getElementById('nihq').value||'').trim(); if(!q) return; window.open(`https://reporter.nih.gov/search/?terms=${encodeURIComponent(q)}`,'_blank','noopener'); }
function openPubMed(){ const q=(document.getElementById('nihq').value||'').trim(); if(!q) return; window.open(`https://pubmed.ncbi.nlm.nih.gov/?term=${encodeURIComponent(q)}`,'_blank','noopener'); }

// Email helper
function sendEmail(){
  const trialId = document.getElementById('trialId').value.trim();
  const name = document.getElementById('yourName').value.trim();
  const email = document.getElementById('yourEmail').value.trim();
  const msg = document.getElementById('message').value.trim();
  const status = document.getElementById('emailStatus');
  if(!trialId || !name || !email || !msg){ status.textContent = 'Please fill in all fields.'; return; }
  const mailto = `mailto:?subject=Inquiry about trial ${encodeURIComponent(trialId)}&body=${encodeURIComponent(msg+"\n\nFrom: "+name+" ("+email+")")}`;
  window.location.href = mailto; status.textContent = 'Email client opened to send your message.';
}

// Connectivity self‑test
async function selfTest(){
  const out = document.getElementById('selfOut');
  const hint = document.getElementById('selfHint');
  const url = 'https://clinicaltrials.gov/api/query/study_fields?expr=test&fields=NCTId&min_rnk=1&max_rnk=1&fmt=json';
  out.textContent = 'Running…'; hint.textContent = '';
  try{
    const res = await fetch(url);
    out.textContent = `ClinicalTrials.gov StudyFields endpoint: ${res.status} ${res.ok? 'OK' : 'Blocked'}`;
    if(!res.ok){ hint.textContent = 'Try another browser, disable privacy/ad‑blockers for this site, or switch networks.'; }
  }catch(e){ out.textContent = 'Self‑test error: '+e.message; hint.textContent = 'Likely a browser extension or network policy issue.'; }
}

// Press Enter in the query box to search
document.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && document.activeElement && document.activeElement.id==='q'){ runSearch(); }});
</script>
</body>
</html>
